<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text to Audio</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="row">
          <h1>Sintetizador de Texto para √Åudio</h1>
          <button id="theme-toggle" class="theme-toggle" title="Mudar tema">
            üåô
          </button>
        </div>
        <p class="muted">
          Cole um texto, insira uma URL ou escolha uma voz para gerar o √°udio.
        </p>
        <form id="synthesize-form">
          <div class="row-container">
            <div class="row-container">
              <label for="raw_text">Cole o texto aqui:</label>
              <textarea
                id="raw_text"
                name="raw_text"
                placeholder="Digite ou cole o texto que deseja sintetizar..."
                style="width: 100%"
              ></textarea>
            </div>

            <div class="row-container">
              <label for="url">Ou insira uma URL:</label>
              <input
                type="text"
                id="url"
                name="url"
                placeholder="https://exemplo.com/artigo"
              />
            </div>

            <div class="row-container">
              <label for="voice">Escolha uma voz:</label>
              <select id="voice" name="voice">
                <optgroup label="Portugu√™s">
                  <option value="v2/pt_speaker_0" selected>
                    Portugu√™s - Masculino 1
                  </option>
                  <option value="v2/pt_speaker_1">
                    Portugu√™s - Masculino 2
                  </option>
                  <option value="v2/pt_speaker_2">
                    Portugu√™s - Masculino 3
                  </option>
                  <option value="v2/pt_speaker_3">
                    Portugu√™s - Masculino 4
                  </option>
                </optgroup>
                <optgroup label="Ingl√™s">
                  <option value="v2/en_speaker_0">Ingl√™s - Masculino 1</option>
                  <option value="v2/en_speaker_1">Ingl√™s - Masculino 2</option>
                  <option value="v2/en_speaker_2">Ingl√™s - Masculino 3</option>
                  <option value="v2/en_speaker_3">Ingl√™s - Masculino 4</option>
                </optgroup>
              </select>
            </div>

            <div class="row-container center" style="padding-top: 1em">
              <button
                type="submit"
                id="submit-button"
                style="width: 25em; font-size: 1.25em; color: white"
              >
                Sintetizar
              </button>
            </div>
          </div>
        </form>
      </div>

      <div style="height: 16px"></div>

      <div class="card">
        <div id="result-container">
          <p class="small">
            Nenhum √°udio gerado ainda. Envie um texto para come√ßar.
          </p>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById("synthesize-form");
      const resultContainer = document.getElementById("result-container");
      const submitButton = document.getElementById("submit-button");
      const themeToggle = document.getElementById("theme-toggle");
      const htmlEl = document.documentElement;

      // --- Theme Switcher ---
      function applyTheme(theme) {
        if (theme === "light") {
          htmlEl.setAttribute("data-theme", "light");
          themeToggle.innerHTML = "‚òÄÔ∏è";
        } else {
          htmlEl.removeAttribute("data-theme");
          themeToggle.innerHTML = "üåô";
        }
      }

      themeToggle.addEventListener("click", () => {
        const currentTheme = htmlEl.getAttribute("data-theme");
        const newTheme = currentTheme === "light" ? "dark" : "light";
        localStorage.setItem("theme", newTheme);
        applyTheme(newTheme);
      });

      document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme") || "dark";
        applyTheme(savedTheme);
      });

      // --- Form Submission ---
      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        submitButton.disabled = true;
        submitButton.textContent = "Processando...";
        resultContainer.innerHTML =
          '<p class="small">Gerando √°udio, por favor aguarde...</p>';

        const formData = new FormData(form);
        const rawText = formData.get("raw_text");
        const url = formData.get("url");
        const voice = formData.get("voice");

        try {
          const response = await fetch("/synthesize", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              raw_text: rawText,
              url: url,
              voice: voice,
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || "Ocorreu um erro no servidor.");
          }

          const result = await response.json();

          if (result.audio_path) {
            resultContainer.innerHTML = ""; // Limpa a mensagem de "processando"

            const audioWrapper = document.createElement("div");
            audioWrapper.style.display = "flex";
            audioWrapper.style.alignItems = "center";
            audioWrapper.style.gap = "1em";
            audioWrapper.style.width = "100%";

            const audio = document.createElement("audio");
            audio.controls = true;
            audio.autoplay = true;
            audio.src = result.audio_path;
            audio.style.flexGrow = "1";

            const downloadLink = document.createElement("a");
            downloadLink.href = result.audio_path;
            downloadLink.download = result.audio_path.split("/").pop();
            downloadLink.title = "Baixar √°udio";
            downloadLink.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`;
            downloadLink.style.color = "var(--text-color)";

            const speedControl = document.createElement("input");
            speedControl.style.width = "5em";
            speedControl.type = "range";
            speedControl.title = "Controlar velocidade do √°udio";
            speedControl.min = "0.5";
            speedControl.max = "2";
            speedControl.step = "0.5";
            speedControl.value = "1";

            speedControl.addEventListener("input", (e) => {
              audio.playbackRate = parseFloat(e.target.value);
            });

            const message = document.createElement("p");
            message.className = "card";
            message.textContent = result.content;

            const timeTakenMessage = document.createElement("p");
            const timeTaken = result.time_taken
              ? `Tempo de processamento: ${result.time_taken.toFixed(
                  2
                )} segundos`
              : "";
            timeTakenMessage.textContent = timeTaken;

            resultContainer.appendChild(timeTakenMessage);
            audioWrapper.appendChild(audio);
            audioWrapper.appendChild(speedControl);
            audioWrapper.appendChild(downloadLink);
            resultContainer.appendChild(audioWrapper);
            resultContainer.appendChild(message);
          } else {
            throw new Error("Resposta do servidor n√£o continha um √°udio.");
          }
        } catch (error) {
          resultContainer.innerHTML = `<div class="error"><strong>Erro:</strong> ${error.message}</div>`;
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = "Sintetizar";
        }
      });
    </script>
  </body>
</html>
