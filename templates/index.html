<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text to Audio</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="row">
          <h1>Sintetizador de Texto para √Åudio</h1>
          <button id="theme-toggle" class="theme-toggle" title="Mudar tema">üåô</button>
        </div>
        <p class="muted">Cole um texto, insira uma URL ou escolha uma voz para gerar o √°udio.</p>
        <form id="synthesize-form">
          <div class="row-container">
            <div class="row-container">
              <label for="raw_text">Cole o texto aqui:</label>
              <textarea
                id="raw_text"
                name="raw_text"
                placeholder="Digite ou cole o texto que deseja sintetizar..."
                style="width: 100%"
              ></textarea>
            </div>

            <div class="row-container">
              <label for="url">Ou insira uma URL:</label>
              <input type="text" id="url" name="url" placeholder="https://exemplo.com/artigo" />
            </div>

            <div class="row-container">
              <label for="voice">Escolha uma voz:</label>
              <select id="voice" name="voice">
                <optgroup label="Portugu√™s">
                  <option value="v2/pt_speaker_0" selected>Portugu√™s - Masculino 1</option>
                  <option value="v2/pt_speaker_1">Portugu√™s - Masculino 2</option>
                  <option value="v2/pt_speaker_2">Portugu√™s - Masculino 3</option>
                  <option value="v2/pt_speaker_3">Portugu√™s - Masculino 4</option>
                </optgroup>
                <optgroup label="Ingl√™s">
                  <option value="v2/en_speaker_0">Ingl√™s - Masculino 1</option>
                  <option value="v2/en_speaker_1">Ingl√™s - Masculino 2</option>
                  <option value="v2/en_speaker_2">Ingl√™s - Masculino 3</option>
                  <option value="v2/en_speaker_3">Ingl√™s - Masculino 4</option>
                </optgroup>
              </select>
            </div>

            <div class="row-container center" style="padding-top: 1em">
              <button type="submit" id="submit-button" class="primary-btn">Sintetizar</button>
            </div>
          </div>
        </form>
      </div>

      <div style="height: 16px"></div>

      <div class="card">
        <div id="result-container">
          <p id="message-content" class="small">Nenhum √°udio gerado ainda. Envie um texto para come√ßar.</p>
          <div id="audio-content" style="display: none">
            <p id="time-taken-content"></p>
            <div style="display: flex; justify-content: center; align-items: center; height: auto">
              <audio id="audio-player" controls style="flex-grow: 1"></audio>
              <a
                href=""
                title="Baixar √°udio (WAV)"
                id="download-link"
                style="color: var(--text-color); display: none; margin-left: 1em"
                target="_blank"
                noreferrer
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
              </a>
            </div>
            <p id="content-text" class="card" style="display: none"></p>
          </div>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById("synthesize-form");
      const messageContent = document.getElementById("message-content");
      const timeTakenMessage = document.getElementById("time-taken-content");
      const audioContent = document.getElementById("audio-content");
      const audioPlayer = document.getElementById("audio-player");
      const downloadLink = document.getElementById("download-link");
      const textContent = document.getElementById("content-text");
      const submitButton = document.getElementById("submit-button");
      const themeToggle = document.getElementById("theme-toggle");
      const htmlEl = document.documentElement;

      // --- Web Audio (streaming) ---
      let audioContext;
      let mediaStreamDestination;
      let nextStartTime = 0;
      let activeSources = [];

      audioPlayer.playbackRate = 1.25; // Velocidade padr√£o

      themeToggle.addEventListener("click", () => {
        const currentTheme = htmlEl.getAttribute("data-theme");
        const newTheme = currentTheme === "light" ? "dark" : "light";
        localStorage.setItem("theme", newTheme);
        applyTheme(newTheme);
      });

      document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme") || "dark";
        applyTheme(savedTheme);
      });

      // --- Theme Switcher ---
      const applyTheme = (theme) => {
        if (theme === "light") {
          htmlEl.setAttribute("data-theme", "light");
          themeToggle.innerHTML = "‚òÄÔ∏è";
        } else {
          htmlEl.removeAttribute("data-theme");
          themeToggle.innerHTML = "üåô";
        }
      };

      // --- Web Audio (streaming) ---
      const getAudioContext = () => {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioContext.state === "suspended") {
          audioContext.resume();
        }
        return audioContext;
      };

      const resetStreamingPlayback = () => {
        activeSources.forEach((s) => {
          try {
            s.stop(0);
          } catch (_) {}
        });
        activeSources = [];

        const ctx = getAudioContext();
        mediaStreamDestination = ctx.createMediaStreamDestination();

        audioPlayer.srcObject = mediaStreamDestination.stream;
        audioPlayer.src = "";
        audioPlayer.play().catch(() => {});

        nextStartTime = Math.max(ctx.currentTime + 0.05, 0);
      };

      class ScheduleChunk {
        constructor(done) {
          this.done = done;
          this.audio_file = undefined;
        }

        append(float32Array, sampleRate) {
          const ctx = getAudioContext();

          const buffer = ctx.createBuffer(1, float32Array.length, sampleRate);
          buffer.getChannelData(0).set(float32Array);

          const src = ctx.createBufferSource();
          src.buffer = buffer;

          const speed = audioPlayer.playbackRate || 1;
          src.playbackRate.value = speed;

          const lookahead = 0.02; // 20ms
          const startAt = Math.max(nextStartTime, ctx.currentTime + lookahead);
          const actualDur = buffer.duration / speed;

          const gain = ctx.createGain();
          const fade = Math.min(0.005, Math.max(0, actualDur / 10));

          gain.gain.setValueAtTime(0, startAt);
          gain.gain.linearRampToValueAtTime(1, startAt + fade);
          gain.gain.setValueAtTime(1, startAt + actualDur - fade);
          gain.gain.linearRampToValueAtTime(0, startAt + actualDur);

          src.connect(gain);
          gain.connect(mediaStreamDestination);

          src.start(startAt);
          nextStartTime = startAt + actualDur;
          activeSources.push(src);

          src.onended = () => {
            try {
              src.disconnect();
            } catch {}
            try {
              gain.disconnect();
            } catch {}
            activeSources = activeSources.filter((s) => s !== src);

            // Trocar para o arquivo final somente quando todos os chunks acabarem
            if (activeSources.length === 0 && this.done) {
              audioPlayer.srcObject = null;
              audioPlayer.src = this.audio_file;
              audioPlayer.load();
            }
          };
        }
      }
      const scheduleChunk = new ScheduleChunk(false);

      // --- Form Submission with Streaming ---
      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        submitButton.disabled = true;
        submitButton.textContent = "Processando...";
        messageContent.innerHTML = "Iniciando processo...";
        timeTakenMessage.textContent = "";
        textContent.textContent = "";
        downloadLink.href = "";
        audioContent.style.display = "none";
        downloadLink.style.display = "none";

        // Preparar streaming
        resetStreamingPlayback();

        const formData = new FormData(form);
        const rawText = formData.get("raw_text");
        const url = formData.get("url");
        const voice = formData.get("voice");

        try {
          const response = await fetch("/synthesize", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "text/event-stream",
              "Cache-Control": "no-cache",
            },
            body: JSON.stringify({ raw_text: rawText, url, voice }),
          });

          if (!response.ok || !response.body) {
            const errorData = await response.json();
            throw new Error(errorData.detail || "Ocorreu um erro no servidor.");
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let streamBuffer = "";

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            streamBuffer += decoder.decode(value, { stream: true });
            const messages = streamBuffer.split("\n\n");
            streamBuffer = messages.pop(); // Keep incomplete message

            for (const message of messages) {
              if (!message.startsWith("data: ")) continue;

              const data = JSON.parse(message.substring(6));

              if (data.status === "started") {
                messageContent.textContent = "Processamento iniciado...";
                continue;
              }

              audioContent.style.display = "block";

              if (data.status === "done") {
                messageContent.textContent = "√Åudio sintetizado com sucesso!";
                downloadLink.href = data.audio;
                downloadLink.style.display = "inline";
                scheduleChunk.done = true;
                scheduleChunk.audio_file = data.audio;
              }

              if (Array.isArray(data.audio_data)) {
                // data.audio_data √© PCM float [-1, 1]
                const f32 = Float32Array.from(data.audio_data);
                scheduleChunk.append(f32, data.sample_rate || 24000);
                audioPlayer.play().catch(() => {});
              }

              timeTakenMessage.textContent = `Tempo de processamento: ${data.time_taken.toFixed(2)} segundos`;
              textContent.innerHTML = data?.content ?? "";
              textContent.style.display = data?.content ? "block" : "none";
            }
          }
        } catch (error) {
          messageContent.innerHTML = `<div class="error"><strong>Erro:</strong> ${error.message}</div>`;
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = "Sintetizar";
        }
      });
    </script>
  </body>
</html>
